<ng-container *ngIf="vm$ | async as vm">
  <table class="result-info my-3">
    <tr>
      <th colspan="2">{{ 'matrix.statistics' | translate }}</th>
    </tr>
    <tr>
      <th>{{ 'matrix.simplexResult' | translate }}</th>
      <td>{{ vm.result.resultType }}</td>
    </tr>
    <tr *ngIf="vm.result.time != null">
      <th>{{ 'matrix.runtime' | translate }}</th>
      <td>
        {{ 'matrix.runtimeValue' | translate: { value: vm.result.time } }}
      </td>
    </tr>
    <tr *ngIf="vm.result.pivots != null">
      <th>{{ 'matrix.pivots' | translate }}</th>
      <td>{{ vm.result.pivots }}</td>
    </tr>
    <tr *ngIf="vm.result.A && vm.result.O">
      <th>{{ 'matrix.size' | translate }}</th>
      <td>
        {{
          'matrix.sizeValue'
            | translate: { rows: vm.result.A.length, cols: vm.result.O.length }
        }}
      </td>
    </tr>
  </table>
  <table class="result-info my-3" *ngIf="vm.result.A">
    <tr>
      <th colspan="2">
        <div class="d-flex align-items-center justify-content-between">
          <span>{{ 'matrix.costModifiers' | translate }}</span>
          <button
            pButton
            pRipple
            class="ms-3 p-button-outlined p-button-rounded"
            [class.invisible]="!vm.settingsModified.cost"
            icon="fa-solid fa-rotate-left"
            [pTooltip]="'matrix.costUndoTooltip' | translate"
            (click)="resetCost()"
          ></button>
        </div>
      </th>
    </tr>
    <tr [pTooltip]="'matrix.recipeCostTooltip' | translate">
      <th>{{ 'matrix.recipe' | translate }}</th>
      <td>
        <lab-input-number
          width="8rem"
          [value]="vm.settings.costFactor"
          (setValue)="setCostFactor($event)"
        ></lab-input-number>
      </td>
    </tr>
    <tr [pTooltip]="'matrix.factoryCostTooltip' | translate">
      <th>{{ 'matrix.factory' | translate }}</th>
      <td>
        <lab-input-number
          width="8rem"
          [value]="vm.settings.costFactory"
          (setValue)="setCostFactory($event)"
        ></lab-input-number>
      </td>
    </tr>
    <tr [pTooltip]="'matrix.inputCostTooltip' | translate">
      <th>{{ 'matrix.input' | translate }}</th>
      <td>
        <lab-input-number
          width="8rem"
          [value]="vm.settings.costInput"
          (setValue)="setCostInput($event)"
        ></lab-input-number>
      </td>
    </tr>
    <tr [pTooltip]="'matrix.ignoredCostTooltip' | translate">
      <th>{{ 'matrix.ignored' | translate }}</th>
      <td>
        <lab-input-number
          width="8rem"
          [value]="vm.settings.costIgnored"
          (setValue)="setCostIgnored($event)"
        ></lab-input-number>
      </td>
    </tr>
  </table>
  <p-table
    *ngIf="
      vm.result.A &&
      vm.result.O &&
      vm.result.itemIds &&
      vm.result.recipeIds &&
      vm.result.inputIds
    "
    responsiveLayout="scroll"
    styleClass="p-datatable-sm"
    [value]="vm.result.A"
  >
    <ng-template pTemplate="header">
      <tr>
        <th [colSpan]="vm.result.O.length + 1">
          {{ 'matrix.simplexCanonicalTableau' | translate }}
        </th>
      </tr>
      <tr>
        <th rowspan="2"></th>
        <th rowspan="2">I</th>
        <th [colSpan]="vm.result.itemIds.length">
          {{ 'matrix.items' | translate }}
        </th>
        <th [colSpan]="vm.result.recipeIds.length">
          {{ 'matrix.recipes' | translate }}
        </th>
        <th
          *ngIf="vm.result.inputIds.length"
          [colSpan]="vm.result.inputIds.length"
        >
          {{ 'matrix.inputs' | translate }}
        </th>
        <th rowspan="2">
          <div class="d-flex align-items-center justify-content-between">
            <span>{{ 'matrix.cost' | translate }}</span>
            <button
              pButton
              pRipple
              class="ms-3 p-button-outlined p-button-rounded"
              [class.invisible]="!vm.recipesModified.cost"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'matrix.costUndoTooltip' | translate"
              (click)="resetRecipeCost()"
            ></button>
          </div>
        </th>
      </tr>
      <tr>
        <th *ngFor="let i of vm.result.itemIds">
          <i
            [class]="i | iconClass"
            [pTooltip]="vm.data.itemEntities[i].name"
          ></i>
        </th>
        <th *ngFor="let i of vm.result.recipeIds">
          <i
            [class]="i | iconClass"
            [pTooltip]="vm.data.recipeEntities[i].name"
          ></i>
        </th>
        <th *ngFor="let i of vm.result.inputIds">
          <i
            [class]="i | iconClass"
            [pTooltip]="vm.data.itemEntities[i].name"
          ></i>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
      <tr>
        <td *ngIf="rowIndex !== 0; else objectiveRow">
          <ng-container
            *ngIf="vm.result.recipeIds[rowIndex - 1] as id; else notRecipe"
          >
            <i
              [class]="id | iconClass"
              [pTooltip]="vm.data.recipeEntities[id].name"
            ></i>
          </ng-container>
          <ng-template #notRecipe>
            <i
              *ngIf="
                vm.result.inputIds[
                  rowIndex - 1 - vm.result.recipeIds.length
                ] as id
              "
              [class]="id | iconClass"
              [pTooltip]="vm.data.itemEntities[id].name"
            ></i
          ></ng-template>
        </td>
        <ng-template #objectiveRow>
          <td class="fw-bold">{{ 'matrix.objective' | translate }}</td>
        </ng-template>
        <td *ngFor="let c of row; last as last">
          <div
            *ngIf="
              last && vm.result.recipeIds[rowIndex - 1] as id;
              else valueCell
            "
            class="d-flex align-items-center justify-content-between"
          >
            <lab-input-number
              [pTooltip]="'matrix.recipeCost' | translate"
              tooltipPosition="left"
              width="6rem"
              [hideButtons]="true"
              [value]="c.toString()"
              (setValue)="setRecipeCost(id, $event)"
            ></lab-input-number>
            <button
              pButton
              pRipple
              class="ms-3 p-button-outlined p-button-rounded"
              [class.invisible]="!vm.recipeRaw[id]?.cost"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'matrix.recipeCostUndoTooltip' | translate"
              tooltipPosition="left"
              (click)="setRecipeCost(id)"
            ></button>
          </div>
          <ng-template #valueCell>
            {{ c.toString() }}
          </ng-template>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <th [colSpan]="vm.result.O.length + 1">
          {{ 'matrix.solution' | translate }}
        </th>
      </tr>
      <tr>
        <th rowspan="3"></th>
        <th rowspan="2">I</th>
        <th [colSpan]="vm.result.itemIds.length">
          {{ 'matrix.surplus' | translate }}
        </th>
        <th [colSpan]="vm.result.recipeIds.length">
          {{ 'matrix.recipes' | translate }}
        </th>
        <th
          *ngIf="vm.result.inputIds.length"
          [colSpan]="vm.result.inputIds.length"
        >
          {{ 'matrix.inputs' | translate }}
        </th>
        <th rowspan="2">{{ 'matrix.cost' | translate }}</th>
      </tr>
      <tr>
        <th *ngFor="let i of vm.result.itemIds">
          <i
            [class]="i | iconClass"
            [pTooltip]="vm.data.itemEntities[i].name"
          ></i>
        </th>
        <th *ngFor="let i of vm.result.recipeIds">
          <i
            [class]="i | iconClass"
            [pTooltip]="vm.data.recipeEntities[i].name"
          ></i>
        </th>
        <th *ngFor="let i of vm.result.inputIds">
          <i
            [class]="i | iconClass"
            [pTooltip]="vm.data.itemEntities[i].name"
          ></i>
        </th>
      </tr>
      <tr>
        <td *ngFor="let c of vm.result.O">{{ c.toString() }}</td>
      </tr>
    </ng-template>
  </p-table>
</ng-container>
