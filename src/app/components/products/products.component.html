<p-card *ngIf="vm$ | async as vm" [header]="'products.title' | translate">
  <div
    *ngFor="
      let product of vm.products;
      last as last;
      trackBy: trackSvc.trackById
    "
    class="d-flex align-items-center"
    [class.mb-3]="!last"
  >
    <div class="p-inputgroup">
      <button
        pButton
        pRipple
        type="button"
        class="p-button-outlined icon"
        icon="fa-solid fa-minus"
        [pTooltip]="'products.removeProduct' | translate"
        (click)="removeProduct(product.id)"
      ></button>
      <!-- Mobile icon item picker -->
      <button
        pButton
        pRipple
        type="button"
        class="d-inline-flex d-sm-none text-truncate"
        [icon]="product.itemId | iconSmClass"
        [pTooltip]="'products.changeItem' | translate"
        (click)="editPicker.clickOpen(vm.data, product.itemId)"
      ></button>
      <!-- Desktop icon-text item picker -->
      <button
        pButton
        pRipple
        type="button"
        class="d-none d-sm-inline-flex text-truncate"
        [icon]="product.itemId | iconSmClass"
        [label]="vm.data.itemEntities[product.itemId].name"
        [pTooltip]="'products.changeItem' | translate"
        tooltipPosition="top"
        (click)="editPicker.clickOpen(vm.data, product.itemId)"
      ></button>
      <lab-picker
        #editPicker
        (selectId)="setItem(product.id, $event)"
      ></lab-picker>
      <span class="d-none d-md-block p-inputgroup-addon">{{
        'products.limitTo' | translate
      }}</span>
      <!-- Mobile number rate picker -->
      <lab-input-number
        class="d-inline-flex d-sm-none"
        [pTooltip]="'products.changeRate' | translate"
        tooltipPosition="top"
        [hideButtons]="true"
        [value]="product.rate"
        (setValue)="setRate(product.id, $event)"
      ></lab-input-number>
      <!-- Desktop number/buttons rate picker -->
      <lab-input-number
        class="d-none d-sm-inline-flex"
        [pTooltip]="'products.changeRate' | translate"
        tooltipPosition="top"
        [value]="product.rate"
        (setValue)="setRate(product.id, $event)"
      ></lab-input-number>
      <p-dropdown
        [tooltip]="'products.changeRateType' | translate"
        tooltipPosition="top"
        [options]="vm.rateTypeOptions"
        [ngModel]="product.rateType"
        (onChange)="setRateType(product.id, $event.value)"
      ></p-dropdown>
      <ng-container
        *ngIf="vm.viaOptions[product.id].length > 0; else recipeNone"
      >
        <ng-container *ngIf="product.viaId as id">
          <ng-container
            *ngIf="product.rateType | rateTypeViaDropdown as dropdownType"
          >
            <!-- Mobile icon via dropdown -->
            <p-dropdown
              labDropdownBase="icon"
              class="d-inline-flex d-sm-none icon"
              [virtualScroll]="true"
              [virtualScrollItemSize]="34"
              [tooltip]="'products.changeVia' | translate"
              tooltipPosition="top"
              [options]="vm.viaOptions[product.id]"
              [ngModel]="product.viaId"
              (onChange)="setVia(product.id, $event.value)"
            >
              <ng-template pTemplate="selectedItem" let-item>
                <div class="d-flex">
                  <i [class]="item.value | iconSmClass: dropdownType"></i>
                </div>
              </ng-template>
              <ng-template pTemplate="item" let-item>
                <div
                  class="d-flex align-items-center py-2 w-100 h-100"
                  [pTooltip]="
                    dropdownType === 'recipe'
                      ? (item.value | recipeTooltip: vm.data)
                      : (item.value | itemTooltip: vm.data)
                  "
                  [escape]="false"
                >
                  <i [class]="item.value | iconSmClass: dropdownType"></i>
                  <div class="ms-3 text-truncate">
                    {{ item.label }}
                  </div>
                </div>
              </ng-template>
            </p-dropdown>
            <!-- Desktop icon-text via dropdown -->
            <p-dropdown
              labDropdownBase
              class="d-none d-sm-inline-flex"
              [virtualScroll]="true"
              [virtualScrollItemSize]="34"
              [tooltip]="'products.changeVia' | translate"
              tooltipPosition="top"
              [options]="vm.viaOptions[product.id]"
              [ngModel]="product.viaId"
              (onChange)="setVia(product.id, $event.value)"
            >
              <ng-template pTemplate="selectedItem" let-item>
                <span *ngIf="item.value === product.itemId; else viaSelected">
                  {{ 'products.changeVia' | translate }}
                </span>
                <ng-template #viaSelected>
                  <div class="d-flex align-items-center h-100">
                    <i [class]="item.value | iconSmClass: dropdownType"></i>
                    <div class="ms-3 text-truncate">
                      {{ item.label }}
                    </div>
                  </div>
                </ng-template>
              </ng-template>
              <ng-template pTemplate="item" let-item>
                <div
                  class="d-flex align-items-center py-2 w-100 h-100"
                  [pTooltip]="
                    dropdownType === 'recipe'
                      ? (item.value | recipeTooltip: vm.data)
                      : (item.value | itemTooltip: vm.data)
                  "
                  tooltipPosition="left"
                  [escape]="false"
                >
                  <i [class]="item.value | iconSmClass: dropdownType"></i>
                  <div class="ms-3 text-truncate">
                    {{ item.label }}
                  </div>
                </div>
              </ng-template>
            </p-dropdown>
          </ng-container>
        </ng-container>
      </ng-container>
      <ng-template #recipeNone>
        <span class="p-inputgroup-addon p-error">{{
          'products.noEnabledRecipes' | translate
        }}</span>
      </ng-template>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-auto mt-2">
      <button
        pButton
        type="button"
        pRipple
        icon="fa-solid fa-plus"
        [label]="'products.addAProduct' | translate"
        (click)="addPicker.clickOpen(vm.data)"
      >
        <lab-picker #addPicker (selectId)="addProduct($event)"></lab-picker>
      </button>
    </div>
    <div class="col-auto mt-2">
      <p-dropdown
        labDropdownTranslate
        styleClass="h-100"
        [tooltip]="'products.selectDisplayRate' | translate"
        [ngModel]="vm.displayRate"
        [options]="displayRateOptions"
        (onChange)="setDisplayRate($event.value, vm.displayRate)"
      >
      </p-dropdown>
    </div>
  </div>
</p-card>
