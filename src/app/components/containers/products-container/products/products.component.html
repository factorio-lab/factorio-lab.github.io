<div class="flex add-button relative">
  <button type="button" title="Add Product" (click)="adding = true">
    <i class="material-icons">add</i>
  </button>
  <lab-picker
    *ngIf="adding"
    [data]="data"
    [categoryId]="categoryId"
    [itemId]="data.itemIds[0]"
    (cancel)="adding = false"
    (selectTab)="categoryId = $event"
    (selectItem)="add.emit($event)"
  ></lab-picker>
  <div *ngIf="!products?.length" class="flex">
    <i class="material-icons">arrow_back</i>Click to add a product
  </div>
</div>
<div *ngIf="products && products.length">
  <div class="product-row" *ngFor="let product of products; trackBy: trackBy">
    <ng-container *ngIf="product && data.itemEntities[product.itemId]">
      <button
        type="button"
        title="Remove Product"
        (click)="remove.emit(product.id)"
      >
        <i class="material-icons">remove</i>
      </button>
      <div class="icon-container">
        <div class="relative">
          <lab-icon
            class="clickable"
            title="Change Product"
            [iconId]="product.itemId"
            [data]="data"
            (click)="clickEditProduct(product)"
          ></lab-icon>
          <lab-picker
            *ngIf="
              edit &&
              edit.product === product &&
              edit.type === ProductEditType.Product
            "
            [data]="data"
            [categoryId]="categoryId"
            [itemId]="product.itemId"
            (cancel)="edit = null"
            (selectTab)="categoryId = $event"
            (selectItem)="commitEditProduct(product, $event)"
          ></lab-picker>
        </div>
      </div>
      <input
        type="number"
        min="0"
        step="any"
        title="Set Output Rate"
        [value]="product.rate"
        (change)="emitNumber(editRate, product.id, $event)"
      />
      <select
        title="Set Rate Type"
        [ngModel]="product.rateType"
        (change)="emitNumber(editRateType, product.id, $event)"
      >
        <option label="Items" [value]="RateType.Items"></option>
        <option label="Belts" [value]="RateType.Belts"></option>
        <option label="Wagons" [value]="RateType.Wagons"></option>
        <option label="Factories" [value]="RateType.Factories"></option>
      </select>
      <ng-container *ngIf="product.rateType === RateType.Factories">
        <ng-container
          *ngIf="productRecipes[product.itemId].length > 0; else recipeNone"
        >
          <ng-container *ngIf="getRecipe(product) as recipe">
            <ng-container
              *ngIf="
                productRecipes[product.itemId].length === 1;
                else recipePicker
              "
            >
              <lab-icon
                [iconId]="recipe"
                [tooltip]="data.recipeEntities[recipe].name"
                [recipe]="data.recipeEntities[recipe]"
                [data]="data"
              >
              </lab-icon>
            </ng-container>
            <ng-template #recipePicker>
              <div class="relative">
                <lab-icon
                  class="clickable"
                  title="Choose recipe"
                  [iconId]="recipe"
                  [tooltip]="data.recipeEntities[recipe].name"
                  [recipe]="data.recipeEntities[recipe]"
                  [data]="data"
                  (click)="
                    edit = { product: product, type: ProductEditType.Recipe }
                  "
                >
                </lab-icon>
                <lab-select
                  *ngIf="
                    edit &&
                    edit.product === product &&
                    edit.type === ProductEditType.Recipe
                  "
                  [selectedId]="recipe"
                  [options]="getOptions(product)"
                  [data]="data"
                  (cancel)="edit = null"
                  (selectId)="
                    editRecipe.emit({ id: product.id, value: $event })
                  "
                >
                </lab-select>
              </div>
            </ng-template>
          </ng-container>
        </ng-container>
        <ng-template #recipeNone>
          <div class="invalid">No matching enabled recipes</div>
        </ng-template>
      </ng-container>
    </ng-container>
  </div>
</div>
