<h2>Products</h2>
<div class="panel">
  <lab-picker
    [data]="data"
    [selected]="data.itemIds[0]"
    (selectId)="addProduct.emit($event)"
  >
    <button title="Add product">
      <i class="material-icons">add</i>
      <div class="text" *ngIf="!products?.length">Click to add a product</div>
    </button></lab-picker
  >
  <div *ngIf="products && products.length">
    <div class="product-row" *ngFor="let product of products; trackBy: trackBy">
      <ng-container *ngIf="product && data.itemEntities[product.itemId]">
        <button title="Remove product" (click)="removeProduct.emit(product.id)">
          <i class="material-icons">remove</i>
        </button>
        <lab-picker
          [data]="data"
          [selected]="product.itemId"
          (selectId)="changeItem(product, $event)"
        >
          <lab-icon
            class="button"
            title="Change item"
            hoverIcon="settings"
            [data]="data"
            [iconId]="product.itemId"
            [tooltip]="data.itemEntities[product.itemId].name"
            [item]="data.itemEntities[product.itemId]"
            [displayRate]="displayRate"
          ></lab-icon
        ></lab-picker>
        <input
          type="number"
          min="0"
          step="any"
          title="Set output rate"
          placeholder="Rate"
          data-test="lab-products-rate"
          [value]="product.rate"
          (input)="changeRate(product.id, $event)"
        />
        <lab-options
          title="Change rate type"
          [selected]="product.rateType"
          [options]="RateTypeOptions"
          (selectId)="setRateType.emit({ id: product.id, value: $event })"
        ></lab-options>
        <ng-container *ngIf="product.rateType === RateType.Factories">
          <ng-container
            *ngIf="productRecipes[product.itemId].length > 0; else recipeNone"
          >
            <ng-container *ngIf="getRecipe(product) as recipe">
              <span>via</span>
              <ng-container
                *ngIf="
                  productRecipes[product.itemId].length === 1;
                  else recipePicker
                "
              >
                <lab-icon
                  class="pad"
                  [iconId]="recipe"
                  [tooltip]="data.recipeEntities[recipe].name"
                  [recipe]="data.recipeEntities[recipe]"
                  [data]="data"
                >
                </lab-icon>
              </ng-container>
              <ng-template #recipePicker>
                <lab-select
                  header="Select a step to calculate by"
                  [data]="data"
                  [selected]="recipe"
                  [options]="getOptions(product)"
                  [selectType]="IdType.Recipe"
                  (selectId)="setVia.emit({ id: product.id, value: $event })"
                >
                  <lab-icon
                    class="button"
                    title="Change rate step"
                    hoverIcon="settings"
                    [data]="data"
                    [iconId]="recipe"
                    [tooltip]="data.recipeEntities[recipe].name"
                    [recipe]="data.recipeEntities[recipe]"
                  >
                  </lab-icon>
                </lab-select>
              </ng-template>
            </ng-container>
          </ng-container>
          <ng-template #recipeNone>
            <div class="invalid">No matching enabled recipes</div>
          </ng-template>
        </ng-container>
      </ng-container>
    </div>
  </div>
</div>
