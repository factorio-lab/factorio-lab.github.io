<table *ngIf="steps && steps.length">
  <thead>
    <tr>
      <!-- Expand -->
      <th class="relative">
        <i
          title="Select columns"
          class="clickable material-icons"
          (click)="edit = { step: null, type: StepEditType.Columns }"
          >visibility</i
        >
        <lab-multiselect
          *ngIf="edit?.type === StepEditType.Columns"
          [header]="'Select Columns'"
          [enabledIds]="columns"
          [options]="ColumnsAsOptions"
          (cancel)="edit = null"
          (enableId)="showColumn.emit($event)"
          (disableId)="hideColumn.emit($event)"
        ></lab-multiselect>
      </th>
      <th>
        <div>
          Items{{ rateLabel }}
          <i
            *ngIf="modifiedIgnore"
            title="Undo all ignored steps"
            class="clickable material-icons"
            (click)="resetIgnore.emit()"
            >undo</i
          >
        </div>
      </th>
      <th *ngIf="show[Column.Belts]">
        <div>
          Belts
          <i
            *ngIf="modifiedBelt"
            title="Undo all belt modifications"
            class="clickable material-icons"
            (click)="resetBelt.emit()"
            >undo</i
          >
        </div>
      </th>
      <th *ngIf="show[Column.Factories]">
        <div>
          Factories
          <i
            *ngIf="modifiedFactory"
            title="Undo all factory modifications"
            class="clickable material-icons"
            (click)="resetFactory.emit()"
            >undo</i
          >
        </div>
      </th>
      <th *ngIf="show[Column.Modules]">
        <div>
          Modules
          <i
            *ngIf="modifiedModules"
            title="Undo all module modifications"
            class="clickable material-icons"
            (click)="resetModules.emit()"
            >undo</i
          >
        </div>
      </th>
      <th *ngIf="show[Column.Beacons]">
        <div>
          Beacons
          <i
            *ngIf="modifiedBeacons"
            title="Undo all beacon modifications"
            class="clickable material-icons"
            (click)="resetBeacons.emit()"
            >undo</i
          >
        </div>
      </th>
      <th *ngIf="show[Column.Power]"><div>Power</div></th>
      <th *ngIf="show[Column.Pollution]">
        <div>Pollution{{ rateLabel }}</div>
      </th>
      <!-- Reset / Link -->
      <th></th>
    </tr>
  </thead>
  <tbody>
    <ng-container *ngFor="let step of steps; trackBy: trackBy">
      <tr>
        <td>
          <i
            *ngIf="step.parents && !expanded[step.itemId]"
            class="clickable material-icons"
            title="Click to show consumption"
            (click)="expanded[step.itemId] = true"
            >expand_more</i
          >
          <i
            *ngIf="step.parents && expanded[step.itemId]"
            class="clickable material-icons"
            title="Click to hide consumption"
            (click)="expanded[step.itemId] = false"
            >expand_less</i
          >
        </td>
        <td>
          <div class="flex" *ngIf="step.items">
            <div *ngIf="step.items" class="monospace">
              {{ rate(step.items, itemPrecision) }}
            </div>
            <div
              *ngIf="step.surplus && step.surplus.nonzero()"
              class="monospace"
            >
              (+{{ rate(step.surplus, itemPrecision) }})
            </div>
            <lab-icon
              class="clickable"
              [title]="
                itemSettings[step.itemId].ignore
                  ? 'Click to include'
                  : 'Click to ignore'
              "
              [iconId]="step.itemId"
              [class.ignored]="itemSettings[step.itemId].ignore"
              [tooltip]="data.itemEntities[step.itemId]?.name"
              [recipe]="data.recipeEntities[data.itemRecipeIds[step.itemId]]"
              [data]="data"
              (click)="ignoreItem.emit(step.itemId)"
            ></lab-icon>
          </div>
        </td>
        <td *ngIf="show[Column.Belts]">
          <ng-container *ngIf="itemSettings[step.itemId]?.belt as belt">
            <div
              *ngIf="
                step.belts &&
                (!step.recipeId ||
                  !data.itemEntities[recipeSettings[step.recipeId].factory]
                    .factory.research)
              "
              class="flex"
            >
              <div class="monospace">{{ rate(step.belts, beltPrecision) }}</div>
              <ng-container
                *ngIf="
                  data.beltIds.indexOf(belt) === -1;
                  then beltDefault;
                  else beltPicker
                "
              ></ng-container>
              <ng-template #beltDefault>
                <lab-icon
                  class="clickable-size"
                  [iconId]="belt"
                  [tooltip]="data.itemEntities[belt].name"
                  [item]="data.itemEntities[belt]"
                  [displayRate]="displayRate"
                  [data]="data"
                ></lab-icon>
              </ng-template>
              <ng-template #beltPicker>
                <div class="relative">
                  <lab-icon
                    class="clickable"
                    title="Click to change belt"
                    [iconId]="belt"
                    [tooltip]="data.itemEntities[belt].name"
                    [item]="data.itemEntities[belt]"
                    [displayRate]="displayRate"
                    [data]="data"
                    (click)="edit = { step: step, type: StepEditType.Belt }"
                  ></lab-icon>
                  <lab-select
                    *ngIf="
                      edit &&
                      edit.step === step &&
                      edit.type === StepEditType.Belt
                    "
                    [data]="data"
                    [selectedId]="belt"
                    [options]="data.beltIds"
                    [displayRate]="displayRate"
                    (cancel)="edit = null"
                    (selectId)="
                      setBelt.emit({
                        id: step.itemId,
                        value: $event,
                        default: belt
                      })
                    "
                  >
                  </lab-select>
                </div>
              </ng-template>
            </div>
          </ng-container>
        </td>
        <td *ngIf="show[Column.Factories]">
          <ng-container
            *ngIf="recipeSettings[step.recipeId]?.factory as factory"
          >
            <div
              class="flex"
              *ngIf="!step.factories || step.factories.nonzero()"
            >
              <ng-container *ngIf="step.factories">
                <div *ngIf="factory !== 'pumpjack'" class="monospace">
                  {{ rate(step.factories, factoryPrecision) }}
                </div>
                <div *ngIf="factory === 'pumpjack'" class="monospace">
                  {{
                    rate(
                      step.factories.mul(Rational.hundred),
                      factoryPrecision
                    )
                  }}%
                </div>
              </ng-container>
              <ng-container
                *ngIf="step.recipeId !== data.itemRecipeIds[step.itemId]"
              >
                <lab-icon
                  [iconId]="step.recipeId"
                  [tooltip]="data.recipeEntities[step.recipeId].name"
                  [recipe]="data.recipeEntities[step.recipeId]"
                  [data]="data"
                ></lab-icon>
                :
              </ng-container>
              <ng-container
                *ngIf="data.recipeEntities[step.recipeId] as recipe"
              >
                <ng-container
                  *ngIf="
                    recipe.producers && recipe.producers.length > 1;
                    then factoryPicker;
                    else factoryDefault
                  "
                >
                </ng-container>
                <ng-template #factoryDefault>
                  <lab-icon
                    class="clickable-size"
                    [iconId]="factory"
                    [tooltip]="data.itemEntities[factory].name"
                    [item]="data.itemEntities[factory]"
                    [data]="data"
                  ></lab-icon>
                </ng-template>
                <ng-template #factoryPicker>
                  <div class="relative">
                    <lab-icon
                      class="list-edit-factory clickable"
                      title="Click to change factory"
                      [iconId]="factory"
                      [tooltip]="data.itemEntities[factory].name"
                      [item]="data.itemEntities[factory]"
                      [data]="data"
                      (click)="
                        edit = { step: step, type: StepEditType.Factory }
                      "
                    ></lab-icon>
                    <lab-select
                      *ngIf="
                        edit &&
                        edit.step === step &&
                        edit.type === StepEditType.Factory
                      "
                      [data]="data"
                      [selectedId]="factory"
                      [options]="recipe.producers"
                      (cancel)="edit = null"
                      (selectId)="factoryChange(step, $event)"
                    >
                    </lab-select>
                  </div>
                </ng-template>
              </ng-container>
            </div>
          </ng-container>
        </td>
        <td *ngIf="show[Column.Modules]">
          <ng-container
            *ngIf="recipeSettings[step.recipeId]?.modules as modules"
          >
            <div class="flex mod factory">
              <div class="relative" *ngFor="let mod of modules; index as i">
                <lab-icon
                  class="list-edit-factory-module clickable"
                  title="Click to change module"
                  [iconId]="mod"
                  [tooltip]="data.itemEntities[mod]?.name"
                  [item]="data.itemEntities[mod]"
                  [data]="data"
                  (click)="
                    edit = { step: step, type: StepEditType.Module, index: i }
                  "
                ></lab-icon>
                <lab-select
                  *ngIf="
                    edit &&
                    edit.step === step &&
                    edit.type === StepEditType.Module &&
                    edit.index === i
                  "
                  [data]="data"
                  [selectedId]="mod"
                  [options]="data.recipeModuleIds[step.recipeId]"
                  includeEmptyModule="true"
                  [data]="data"
                  (cancel)="edit = null"
                  (selectId)="factoryModuleChange(step, $event, i)"
                >
                </lab-select>
              </div>
            </div>
          </ng-container>
        </td>
        <td *ngIf="show[Column.Beacons]">
          <ng-container
            *ngIf="recipeSettings[step.recipeId]?.beaconModule as module"
          >
            <div class="flex mod">
              <div class="relative">
                <lab-icon
                  class="list-edit-beacon-module clickable"
                  title="Click to change beacon module"
                  [iconId]="module"
                  [tooltip]="data.itemEntities[module]?.name"
                  [item]="data.itemEntities[module]"
                  [data]="data"
                  (click)="edit = { step: step, type: StepEditType.Beacon }"
                ></lab-icon>
                <lab-select
                  *ngIf="
                    edit &&
                    edit.step === step &&
                    edit.type === StepEditType.Beacon
                  "
                  [data]="data"
                  [selectedId]="module"
                  [options]="data.beaconModuleIds"
                  includeEmptyModule="true"
                  (cancel)="edit = null"
                  (selectId)="beaconModuleChange(step, $event)"
                >
                </lab-select>
              </div>
              <input
                *ngIf="module !== MODULE_ID"
                title="Enter number of beacon modules"
                type="number"
                min="0"
                [value]="recipeSettings[step.recipeId].beaconCount"
                (change)="beaconCountChange(step, $event)"
              />
            </div>
          </ng-container>
        </td>
        <td *ngIf="show[Column.Power]">
          <ng-container *ngIf="step.consumption?.nonzero()">
            <div class="monospace">
              {{ power(step.consumption) }}
            </div>
          </ng-container>
        </td>
        <td *ngIf="show[Column.Pollution]">
          <ng-container *ngIf="step.pollution?.nonzero()">
            <div class="monospace">
              {{ rate(step.pollution, factoryPrecision) }}
            </div>
          </ng-container>
        </td>
        <td *ngIf="show[Column.Link]">
          <a
            *ngIf="step.items"
            title="Click to open this step in a new tab"
            [href]="router.stepHref(step)"
            target="_blank"
          >
            <i class="clickable material-icons">open_in_new</i>
          </a>
          <i
            *ngIf="recipeRaw[step.recipeId]"
            title="Undo modifications to this step"
            class="clickable material-icons list-step-reset"
            (click)="resetStep(step)"
            >undo</i
          >
        </td>
      </tr>
      <ng-container
        *ngIf="
          step.recipeId &&
          data.recipeEntities[step.recipeId] &&
          expanded[step.itemId]
        "
      >
        <ng-container
          *ngFor="
            let input of data.recipeEntities[step.recipeId].in | keyvalue;
            first as isFirst;
            last as isLast
          "
        >
          <ng-container *ngIf="findStep(input.key) as inStep">
            <tr
              *ngIf="inStep.parents && inStep.parents[step.recipeId]"
              class="details"
              [class.first]="isFirst"
              [class.last]="isLast"
            >
              <td></td>
              <td>
                <div class="flex">
                  <div *ngIf="inStep.items" class="monospace">
                    {{
                      rate(
                        inStep.items.mul(inStep.parents[step.recipeId]),
                        itemPrecision
                      )
                    }}
                  </div>
                  <lab-icon
                    class="clickable-size"
                    [iconId]="input.key"
                    [tooltip]="data.itemEntities[input.key]?.name"
                    [recipe]="
                      data.recipeEntities[data.itemRecipeIds[input.key]]
                    "
                    [data]="data"
                  >
                  </lab-icon>
                </div>
              </td>
              <td *ngIf="show[Column.Belts]">
                <ng-container *ngIf="itemSettings[inStep.itemId].belt as belt">
                  <div
                    *ngIf="
                      inStep.belts &&
                      (!inStep.recipeId ||
                        !data.itemEntities[
                          recipeSettings[inStep.recipeId].factory
                        ].factory.research)
                    "
                    class="flex"
                  >
                    <div class="monospace">
                      {{
                        rate(
                          inStep.belts.mul(inStep.parents[step.recipeId]),
                          beltPrecision
                        )
                      }}
                    </div>
                    <lab-icon
                      class="clickable-size"
                      [iconId]="belt"
                      [tooltip]="data.itemEntities[belt].name"
                      [item]="data.itemEntities[belt]"
                      [displayRate]="displayRate"
                      [data]="data"
                    ></lab-icon>
                  </div>
                </ng-container>
              </td>
              <td *ngIf="show[Column.Factories]">
                <ng-container
                  *ngIf="
                    inStep.recipeId &&
                    recipeSettings[inStep.recipeId].factory as factory
                  "
                >
                  <div
                    class="flex"
                    *ngIf="!inStep.factories || inStep.factories.nonzero()"
                  >
                    <div *ngIf="inStep.factories" class="monospace">
                      {{
                        rate(
                          inStep.factories.mul(inStep.parents[step.recipeId]),
                          factoryPrecision
                        )
                      }}
                    </div>
                    <ng-container *ngIf="inStep.recipeId !== inStep.itemId">
                      <lab-icon
                        [iconId]="inStep.recipeId"
                        [tooltip]="data.recipeEntities[inStep.recipeId].name"
                        [recipe]="data.recipeEntities[inStep.recipeId]"
                        [data]="data"
                      ></lab-icon>
                      :
                    </ng-container>
                    <lab-icon
                      class="clickable-size"
                      [iconId]="factory"
                      [tooltip]="data.itemEntities[factory].name"
                      [item]="data.itemEntities[factory]"
                      [data]="data"
                    ></lab-icon>
                  </div>
                </ng-container>
              </td>
              <td>
                <div class="flex">
                  <div class="monospace">
                    {{
                      rate(
                        inStep.parents[step.recipeId].mul(Rational.hundred),
                        0
                      )
                    }}%
                  </div>
                  <i class="material-icons">arrow_forward</i>
                  <lab-icon
                    class="clickable-size"
                    [iconId]="step.recipeId"
                    [tooltip]="data.recipeEntities[step.recipeId]?.name"
                    [recipe]="data.recipeEntities[step.recipeId]"
                    [data]="data"
                  ></lab-icon>
                </div>
              </td>
            </tr>
          </ng-container>
        </ng-container>
        <tr>
          <td></td>
        </tr>
      </ng-container>
      <ng-container *ngIf="step.parents && expanded[step.itemId]">
        <tr
          *ngFor="
            let parent of step.parents | keyvalue;
            first as isFirst;
            last as isLast
          "
          class="details"
          [class.first]="isFirst"
          [class.last]="isLast"
        >
          <td></td>
          <td>
            <div class="flex">
              <div *ngIf="step.items" class="monospace">
                {{ rate(step.items.mul(parent.value), itemPrecision) }}
              </div>
              <lab-icon
                class="clickable-size"
                [iconId]="step.itemId"
                [tooltip]="data.itemEntities[step.itemId]?.name"
                [recipe]="data.recipeEntities[step.recipeId]"
                [data]="data"
              >
              </lab-icon>
            </div>
          </td>
          <td *ngIf="show[Column.Belts]">
            <ng-container *ngIf="itemSettings[step.itemId].belt as belt">
              <div
                *ngIf="
                  step.belts &&
                  (!step.recipeId ||
                    !data.itemEntities[recipeSettings[step.recipeId].factory]
                      .factory.research)
                "
                class="flex"
              >
                <div class="monospace">
                  {{ rate(step.belts.mul(parent.value), beltPrecision) }}
                </div>
                <lab-icon
                  class="clickable-size"
                  [iconId]="belt"
                  [tooltip]="data.itemEntities[belt].name"
                  [item]="data.itemEntities[belt]"
                  [displayRate]="displayRate"
                  [data]="data"
                ></lab-icon>
              </div>
            </ng-container>
          </td>
          <td *ngIf="show[Column.Factories]">
            <ng-container
              *ngIf="recipeSettings[step.recipeId]?.factory as factory"
            >
              <div
                class="flex"
                *ngIf="!step.factories || step.factories.nonzero()"
              >
                <div *ngIf="step.factories" class="monospace">
                  {{ rate(step.factories.mul(parent.value), factoryPrecision) }}
                </div>
                <ng-container *ngIf="step.recipeId !== step.itemId">
                  <lab-icon
                    [iconId]="step.recipeId"
                    [tooltip]="data.recipeEntities[step.recipeId].name"
                    [recipe]="data.recipeEntities[step.recipeId]"
                    [data]="data"
                  ></lab-icon>
                  :
                </ng-container>
                <lab-icon
                  class="clickable-size"
                  [iconId]="factory"
                  [tooltip]="data.itemEntities[factory].name"
                  [item]="data.itemEntities[factory]"
                  [data]="data"
                ></lab-icon>
              </div>
            </ng-container>
          </td>
          <td>
            <div class="flex">
              <div class="monospace">
                {{ rate(parent.value.mul(Rational.hundred), 0) }}%
              </div>
              <i class="material-icons">arrow_forward</i>
              <lab-icon
                class="clickable-size"
                [iconId]="parent.key"
                [tooltip]="data.itemEntities[parent.key]?.name"
                [recipe]="data.recipeEntities[data.itemRecipeIds[parent.key]]"
                [data]="data"
              ></lab-icon>
            </div>
          </td>
        </tr>
        <tr>
          <td></td>
        </tr>
      </ng-container>
    </ng-container>
    <tr class="monospace" *ngIf="show[Column.Power] || show[Column.Pollution]">
      <td colspan="6" class="summary-label">Total:</td>
      <td *ngIf="show[Column.Power]">
        {{ totalPower }}
      </td>
      <td *ngIf="show[Column.Pollution]">
        {{ totalPollution }}
      </td>
    </tr>
  </tbody>
</table>
